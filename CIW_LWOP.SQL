-- BELOW USES CIW FOR EMP STATUS --
-- OPEN NOTES:
	-- What about Leave > 1 Year?
	-- What about Leave with expiration of 3999-09-09 00:00:00.000?

	WITH
		LWOP_01 AS
		(SELECT DISTINCT 
				  EMPLOYEE_ID AS EID
				, JOB_EMPLMNT_STATUS_CODE
				, row_number() 
					OVER(
						PARTITION BY EMPLOYEE_ID ORDER BY EMPLOYEE_ID, JOB_EFFECTIVE_DATE
						) 
					AS LEAVERECORD
				, CASE 
					WHEN EXTRACT(MONTH FROM JOB_EFFECTIVE_DATE)
						BETWEEN 1 AND 7 
					THEN 'SPRING'
					ELSE 'FALL'
				END AS SEMESTER				
				, CASE 
					WHEN EXTRACT(MONTH FROM JOB_EFFECTIVE_DATE)
						BETWEEN 1 AND 7 
						THEN 
						/* Academic Year is prior calendar year if Spring Term */
							CONCAT(CONCAT(CAST((EXTRACT(YEAR FROM JOB_EFFECTIVE_DATE) - 1) AS VARCHAR(10))
							, ' - ')
							, 	   CAST((EXTRACT(YEAR FROM JOB_EFFECTIVE_DATE)) AS VARCHAR(10)))
					WHEN EXTRACT(MONTH FROM JOB_EFFECTIVE_DATE)
						BETWEEN 8 AND 12 
						THEN 
							CONCAT(CONCAT(CAST((EXTRACT(YEAR FROM JOB_EFFECTIVE_DATE))AS VARCHAR(10)) 
							, ' - ')
							,CAST((EXTRACT(YEAR FROM JOB_EFFECTIVE_DATE) + 1)AS VARCHAR(10)) )
					END AS AY
				, JOB_EXPIRATION_DATE - JOB_EFFECTIVE_DATE AS Duration_Days
				, ROUND(((JOB_EXPIRATION_DATE - JOB_EFFECTIVE_DATE) / 365),3) AS Annual_Rate
				, CASE 
					WHEN ROUND(((JOB_EXPIRATION_DATE - JOB_EFFECTIVE_DATE) / 365),3) < 0.085 -- Less than 1 mo should be 0
						THEN 0
					WHEN ROUND(((JOB_EXPIRATION_DATE - JOB_EFFECTIVE_DATE) / 365),3) BETWEEN 0.085 AND 0.500  -- BETWEEN one MONTH AND half a YEAR rounded TO .5
						THEN .5
					WHEN ROUND(((JOB_EXPIRATION_DATE - JOB_EFFECTIVE_DATE) / 365),3) BETWEEN .501 AND 1 -- BETWEEN half a YEAR AND one YEAR rounded TO 1
						THEN 1
				END AS ROUNDED_ANNUAL_RATE
			    , JOB_EFFECTIVE_DATE
			    , JOB_EXPIRATION_DATE
				, JOB_POSITION_NUM
			    , JOB_JB_CODE
			    , JOB_DEPT_ID
			FROM artemis.HRMS_JOB_TBL
			WHERE JOB_EMPLMNT_STATUS_CODE IN ('L') -- LWOP
				AND JOB_JB_CODE IN ('1100', '1101' ,'1102' ,'1103')
			ORDER BY EMPLOYEE_ID, LEAVERECORD
		)
SELECT * FROM LWOP_01;
